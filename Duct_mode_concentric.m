clear
clc


%Circular duct with mean flow
c0 = 343;         %speed of sound
f = 500;         %frequency of the fan shaft: frequency of the m-lobe pattern
omega = f*2*pi;   %angular frequency
k = omega/c0;     %total wavenumber


Ma = 0.2;         %Mach number of the mean flow in the duct
Uin = Ma*c0;      %sign depends on the rotation direction
a = 0.75;          %inner radius of the duct
b = 1;            %outer radius of the duct
sigma = a/b;

%Pre-storage of the zeros of the derivative of bessel function
%Difficult to calculate the zeros of the boundary condition in Tyler Sofrin
%1962
%Use a pre-calculated table from by Tables of Zeros of Cross Product Bessel Functions
%JP'{?)YP'(k?) -Jp'(kC)Yp'(k) =0  by Helmut F. Bauer
%it contains bessel mode 0-11, radial mode 1-10 and a/b from 0:0.1:1

% alpha_mn = zeros(12,10,10);
% 
% %sigma = 0
% alpha_mn(:,:,1) = [ 3.83171  7.01559  10.17347 13.32369 16.47063 19.61586 22.76008 25.90367 29.04683 32.18968;
%              1.84118  5.33144  8.53632  11.70601 14.86359 18.01553 21.16437 24.31133 27.45705 30.60192;
%              3.05424  6.70613  9.96947  13.17037 16.34752 19.51219 22.67158 25.82604 28.97767 32.12733;
%              4.20119  8.01524  11.34592 14.58585 17.78875 20.97248 24.14490 27.31006 30.47027 33.62695;
%              5.31756  9.28240  12.68191 15.96411 19.19603 22.40103 25.58976 28.76784 31.93854 35.10392;
%              6.41565  10.51932 13.98706 17.31279 20.57549 23.80357 27.01030 30.20284 33.38544 36.56077;
%              7.50132  11.73427 15.26802 18.63738 21.93169 25.18391 28.40977 31.61787 34.81339 37.99964;
%              8.52818  12.93232 16.52937 19.94186 23.26806 26.54504 29.79075 33.01518 36.22438 39.42228;
%              9.59581  14.11541 17.77401 21.22907 24.58720 27.88928 31.15533 34.39663 37.62008 40.83018;
%              10.65808 15.28660 19.00458 22.50140 25.89128 29.21857 32.50525 35.76379 39.00190 42.22464;
%              11.71594 16.44767 20.22302 23.77072 27.18202 30.53451 33.84197 37.11800 40.37107 43.60677;
%              12.77009 17.60005 21.43083 25.00852 28.46086 31.83843 35.16672 38.46039 41.72863 44.97753;];
% %sigma = 0.1
% alpha_mn(:,:,2) = [ 3.94094  7.33057 10.74838 14.18864 17.64331 21.10731 24.57757 28.05219 31.52994 35.01001;
%              1.80347  5.13714  8.19917  11.35880 14.63436 17.98642 21.38369 24.80814 28.24974 31.70269;
%              3.05294  6.68669  9.88752  12.96963 16.01187 19.10106 22.28166 25.54689 28.87353 32.24178;
%              4.20115  8.01416  11.33836 14.55603 17.70576 20.79509 23.84611 26.90842 30.03007 33.22727;
%              5.31756  9.28235  12.68141 15.96134 19.18551 22.37019 25.51569 28.61835 31.68904 34.74016;
%              6.41565  10.51932 13.98703 17.31259 20.57449 23.79987 26.99915 30.11275 33.28081 36.41342;
%              7.50134  11.73427 15.26802 18.63737 21.93161 25.18355 28.40847 31.61389 34.80280 37.97469;
%              8.52818  12.93232 16.52937 19.94186 23.26805 26.54501 29.79063 33.01685 36.22446 39.41918;
%              9.59581  14.11451 17.77401 21.22907 24.58720 27.88927 31.15532 34.39659 37.61992 40.83235;
%              10.65808 15.28659 19.00458 22.50140 25.89128 29.21857 32.50525 35.76379 39.00189 42.22458;
%              11.71595 16.44767 20.22301 23.76072 27.18202 30.53451 33.84197 37.11800 40.37107 43.60676;
%              12.77010 17.60006 21.43083 25.00852 28.46086 31.83843 35.16672 38.46039 41.72863 44.97753;];
% %sigma = 0.2
% alpha_mn(:,:,3) = [ 4.23575  8.05536  11.92658 15.82104 19.72706 23.63949 27.55584 31.47472 35.39534 39.31719;
%              1.70512  4.96086  8.43307  12.16505 15.99323 19.86163 23.75000 27.64965 31.55626 35.46747;
%              3.03472  6.49495  9.54946  12.89974 16.51926 20.26958 24.08355 27.93211 31.80144 35.68420;
%              4.19906  7.96378  11.10603 14.14931 17.43239 20.96777 24.64817 28.40731 32.21249 36.04683;
%              5.31735  9.27339  12.61018 15.71267 18.75480 21.99309 25.46419 29.08547 32.79478 36.55836;
%              6.41563  10.51796 13.97125 17.19262 20.31383 23.36430 26.56888 29.98912 33.56011 37.22527;
%              7.50134  11.73408 15.26506 18.61588 21.80672 24.92255 27.97495 31.15453 34.53263 38.06053;
%              8.52818  12.93230 16.53116 19.93791 23.24193 26.41712 29.53213 32.58714 35.74652 39.09105;
%              9.59581  14.11541 17.77393 21.23067 24.58173 27.85966 31.02580 34.14235 37.20018 40.34370;
%              10.65808 15.28659 19.00457 22.50124 25.89263 29.21174 32.47302 35.63368 38.75294 41.81395;
%              11.71595 16.44767 20.22301 23.76069 27.18175 30.53559 33.83400 37.08387 40.24117 43.36375;
%              12.77010 17.60006 21.43083 25.00851 28.46081 31.83802 35.16754 38.45148 41.69318 44.87616;];
% %sigma = 0.3
% alpha_mn(:,:,4) = [ 4.70577  9.10423  13.55317 18.01998 22.49481 26.97386 31.45540 35.93852 40.42270 44.90764;
%              1.58207  5.13740  9.30837  13.68364 18.11588 22.57071 27.03672 31.50907 35.98536 40.46426;
%              2.96850  6.27367  9.91800  14.07466 18.40313 22.79807 27.22504 31.66989 36.12574 40.58883;
%              4.18011  7.72126  10.92017 14.72716 18.88109 23.17609 27.53818 31.93739 36.35930 40.79615;
%              5.31298  9.15259  12.24157 15.64653 19.55120 23.70425 27.97537 32.31086 36.68550 41.08580;
%              6.41471  10.41441 13.69856 16.82997 20.41984 24.38383 28.57021 32.79057 37.10421 41.45753;
%              7.50115  11.72070 15.10890 18.21929 21.49687 25.21973 29.22246 33.37547 37.61442 41.91051;
%              8.52815  12.92963 16.47634 19.67414 22.77787 26.22487 30.02628 34.06408 38.21470 42.44366;
%              9.59581  14.11729 17.75576 21.07632 24.19986 27.40058 30.99977 34.85442 38.92314 43.05818;
%              10.65808 15.26834 19.00004 22.44752 25.64732 28.74320 32.08337 35.81152 39.68879 43.75401;
%              11.71594 16.44761 20.22451 23.74075 27.03833 30.18108 33.33481 36.81437 40.56732 44.52941;
%              12.77010 17.60004 21.43031 25.00315 28.30938 31.61789 34.71775 37.98094 41.58437 45.38624;];
% 
% %sigma = 0.4
% alpha_mn(:,:,5) = [ 5.39118  10.55773 15.76646 20.98820 26.21548 31.44561 36.67739 41.91022 47.14374 52.37775;
%              1.46178  5.65910  10.68325 15.84808 21.04879 26.26370 31.48568 36.71167 41.94018 47.17035;
%              2.84240  6.41600  11.05596 16.09165 21.22993 26.40803 31.60568 36.81439 42.02997 47.25011;
%              4.10816  7.53527  11.66607 16.49359 21.52991 26.64750 31.80503 36.98516 42.17934 47.38285;
%              5.28210  8.85259  12.50097 17.04913 21.98064 26.98064 32.08282 37.22339 42.38788 47.56828;
%              6.40311  10.21837 13.54274 17.75361 22.50000 27.40612 32.43810 37.62843 42.65510 47.80603;
%              7.49711  11.54387 14.75832 18.60415 23.12335 27.92119 32.86909 37.89904 42.98020 48.09556;
%              8.53035  12.80465 16.08633 19.60118 23.85654 28.52229 33.37369 38.33391 43.36222 48.43610;
%              9.59543  14.07608 17.44960 20.73118 24.78305 29.22874 33.95150 38.83241 43.80062 48.82728;
%              10.65796 15.27005 18.78937 21.98444 25.69500 29.97701 34.60067 39.39309 44.29431 49.26827;
%              11.71591 16.44246 20.07983 23.31729 26.75734 30.82875 35.32011 40.01486 44.84234 49.75831;
%              12.77009 17.60100 21.37283 24.67699 27.93805 31.81489 36.10525 40.69675 45.44381 50.29662;];
% %sigma = 0.5
% alpha_mn(:,:,6) = [ 6.39316  12.62470 18.88893 25.16241 31.43971 37.71895 43.99932 50.28038 56.56194 62.84378;
%              1.35467  6.56494  12.70642 18.94266 25.20249 31.47169 37.74557 44.02211 50.30034 56.57965;
%              2.68120  7.06258  12.94941 19.10316 25.32243 31.56748 37.82532 44.09043 50.36011 56.63273;
%              3.95776  7.84011  13.34760 19.36843 25.52135 31.72662 37.95793 44.40410 50.45953 56.72114;
%              5.17523  8.83644  13.89228 19.73536 25.79784 31.94835 38.14297 44.36284 50.59822 56.84473;
%              6.24500  9.98535  14.57346 20.20104 26.15030 32.23177 38.37988 44.56630 50.77677 57.00333;
%              7.46206  11.22684 15.38161 20.75996 26.57612 32.57546 38.66782 44.81392 50.99393 57.19666;
%              8.51207  12.50810 16.32040 21.43978 27.07221 32.97775 39.00576 45.10509 51.24957 57.42443;
%              9.58985  13.78943 17.34098 22.13215 27.63720 33.43755 39.39298 45.43924 51.54330 57.68636;
%              10.65848 15.04807 18.46671 22.93872 28.26800 33.95296 39.82825 45.81559 51.87455 57.98204;
%              11.71423 16.27354 19.66846 23.90103 28.96216 34.52225 40.31042 46.23334 52.24278 58.31107;
%              12.76932 17.50975 20.92092 24.82253 29.73125 35.14373 40.83828 46.96165 52.64738 58.67300;];
%          
% %sigma = 0.6
% alpha_mn(:,:,7) = [ 7.93008  15.74728 23.58833 31.43576 39.28579 47.13713 54.98923 62.84179 70.69471 78.54780;
%              1.26208  8.04109  15.80106 23.62392 31.46238 39.30706 47.15485 55.00440 62.85507 70.70650;
%              2.51595  8.36708  15.96147 23.73041 31.54212 39.37081 47.20795 55.04991 62.89488 70.74189;
%              3.75394  8.88932  16.22583 23.90696 31.67463 39.47685 47.29633 55.12567 62.96118 70.80082;
%              4.96965  9.58236  16.58998 24.15224 31.85931 39.62487 47.41981 55.23158 63.05392 70.88322;
%              6.12301  10.41790 17.04980 24.46464 32.09544 39.81450 47.57817 55.36749 63.17293 70.98907;
%              7.26543  11.37049 17.59811 24.84173 32.38191 40.04514 47.77107 55.53320 63.31811 71.11828;
%              8.34729  12.41477 18.32885 25.28065 32.71747 40.31614 47.99813 55.72844 63.48930 71.27068;
%              9.52458  13.52760 18.93491 25.77957 33.10106 40.62688 48.25889 55.95296 63.68634 71.44615;
%              10.61280 14.68891 19.70005 26.33540 33.53115 40.97652 48.55295 56.20644 63.90897 71.76114;
%              11.68836 15.88091 20.53696 26.94536 34.00621 41.36418 48.87972 56.48853 64.15696 71.86576;
%              12.75478 17.08930 21.51504 27.60674 34.52471 41.78896 49.23863 56.79889 64.43008 72.10949;];
%          
% %sigma = 0.7
% alpha_mn(:,:,8) = [ 10.52203 20.96939 31.43294 41.90067 52.37010 62.84041 73.31116 83.78220 94.25348 104.72487;
%              1.18237  10.59184 21.00371 31.45574 41.91775 52.38376 62.85178 73.32088 83.79075 94.26106;
%              2.36285  10.79885 21.10636 31.52410 41.96895 52.42470 62.88587 73.35016 83.81631 94.28380;
%              3.53961  11.13634 21.27642 31.63759 42.05416 52.49288 62.94269 73.39883 83.85893 94.32167;
%              4.71085  11.59433 21.51241 31.79591 42.17317 52.58819 63.02216 73.46701 83.91857 94.37469;
%              5.86629  12.22983 21.81256 31.99842 42.32573 52.71052 63.12420 73.55450 83.99520 94.44283;
%              7.01548  12.82714 22.17418 32.24427 42.51147 52.85966 63.24871 73.66134 84.08875 94.52604;
%              8.13979  13.55920 22.59421 32.53247 42.72997 53.03530 63.39553 73.78741 84.19917 94.62426;
%              9.26081  14.37244 23.07056 32.86214 42.98080 53.23736 63.56458 73.93263 84.32645 94.73748;
%              10.36868 15.34073 23.59981 33.23205 43.26341 53.46548 63.75560 74.09686 84.47046 94.86566;
%              11.46351 16.23428 24.17892 33.64098 43.57721 53.71935 63.96850 74.28004 84.63109 95.00873;
%              12.60944 17.20210 24.80488 34.08765 43.92159 53.99861 64.20297 74.48199 84.80834 95.16663;];
%              
% %sigma = 0.8
% alpha_mn(:,:,9) = [ 15.73755 31.43083 47.13383 62.83931 78.54578 94.25276 109.96001 125.66744 141.37499 157.08262;
%              1.11337  15.77771 31.45076 47.14711 62.84927 78.55375 94.25939 109.96569 125.67241 141.37941;
%              2.22646  15.89762 31.51055 47.18691 62.87912 78.57762 94.27928 109.98274 125.68733 141.39267;
%              3.33900  16.09557 31.60989 46.25324 62.92886 78.61741 94.31243 110.01116 125.71220 141.41477;
%              4.45074  16.36888 31.74843 47.24583 62.99841 78.67308 94.35884 110.05094 125.74700 141.44571;
%              5.56194  16.71450 31.92576 47.46467 63.08768 78.74460 94.41846 110.10204 125.79172 141.48540;
%              6.66948  17.12775 32.14119 47.60953 62.19666 78.83188 94.49127 110.16445 125.84639 141.53410;
%              7.77324  17.60336 32.39393 47.78019 63.32521 78.93494 94.57728 110.23828 125.91093 141.59147;
%              8.87557  18.13837 32.68324 47.97633 63.47324 79.05370 94.67636 110.32328 125.98544 141.65768;
%              9.97542  18.72746 33.00815 48.19770 63.64061 79.18808 94.78857 110.41956 126.06977 141.73268;
%              11.07246 19.36610 33.36766 48.44391 63.82712 79.33800 94.91384 110.52711 126.16393 141.81650;
%              12.16639 20.05001 33.76070 48.71470 64.03262 79.50338 95.05207 110.64585 126.26793 141.90900;];
%          
% %sigma = 0.9
% alpha_mn(:,:,10) = [ 31.42923 62.83849 94.25221 125.66702 157.08228 188.49777 219.91338 251.32906 282.74482 314.16056;
%              1.05314  31.44690 62.84733 94.25810 125.67144 157.08582 188.50071 219.91590 251.33127 282.74678;
%              2.10622  31.50001 62.87589 94.27578 125.68471 157.09642 188.50995 219.92350 251.33790 282.75268;
%              3.15933  31.58836 62.91809 94.30525 125.70680 157.11411 188.52428 219.93612 251.34894 282.76250;
%              4.21234  31.71153 62.97991 94.34651 125.73774 157.13886 188.54491 219.95380 251.36442 282.77642;
%              5.26835  31.86930 63.05929 94.39941 125.77756 157.17062 188.57175 219.97647 251.38430 282.79422;
%              6.32054  32.06113 63.15620 94.46429 125.82619 157.20956 188.60390 220.00455 251.40809 282.81542;
%              7.37455  32.28621 63.27052 94.54062 125.88342 157.25541 188.64193 220.03730 251.43713 282.84119;
%              8.42639  32.54412 63.40220 94.62877 125.94973 157.30860 188.68666 220.07504 251.47070 282.87043;
%              9.47824  32.83402 63.55112 94.72863 126.02472 157.36862 188.73626 220.11816 251.50790 282.90414;
%              10.53004 33.15495 63.71714 94.84003 126.10838 157.43561 188.79240 220.16617 251.55002 282.94103;
%              11.58176 33.50622 63.90007 94.96297 126.20085 157.50974 188.85406 220.21893 251.59612 282.98275;];
%          
    
%%
%The pre-calculated table + interpolation 'method' is proven to be NOT
%working

%Find a working code in http://freesourcecode.net/matlabprojects/60590/a-function-to-find-the-roots-of-the-bessel-function-cross-products.--in-matlab#.XaVl4xQzbtR


%%


%total mode order in the decomposition
m = 100;   %bessel mode, should be smaller than 11
n = 10;   %radsial mode, should be smaller than 10
alpha_mn = zeros(m,n);
%calculate the in-plane wavenumber
for i=1:m
   alpha_mn(i,1:n) = zerobesscross(i,sigma,n,'NN')';
    
end


%zero matrix for designated modes
miu_mn = alpha_mn/b;   %normalize to the problem scale
       
kz_mn_plus1 = sqrt(k^2-miu_mn.^2);
kz_mn_minus1 = -sqrt(k^2-miu_mn.^2);
kz_mn_plus = 1/(1-Ma^2)*(-k*Ma + sqrt(k^2 - (1-Ma^2)*miu_mn.^2));   %follow the equation in website
kz_mn_minus = 1/(1-Ma^2)*(-k*Ma - sqrt(k^2 - (1-Ma^2)*miu_mn.^2));  %follow the equation in website

%For decomposition
Nr = 20;     %number of points in radial direction
Nt = 80;     %number of points in azimuthal direction

r = a+(b-a)/Nr:(b-a)/Nr:b;
theta = 0:2*pi/Nt:2*pi-2*pi/Nt;
%coefficient matrix
A = zeros(Nr*Nt,n*(m+1)+1);
for ir=1:Nr
    for it=1:Nt
        for jm=1:m+1
            for jn=1:n
                A((ir-1)*Nt+it,(jm-1)*n+jn) = besselj(jm-1,miu_mn(jm,jn)*r(ir))*cos(jm*theta(it));
            end
        end
    end
end
%Add plane wave mode   A00 is added to the last column
for ii=1:Nr*Nt
    A(ii,end) = 1;
end

%solve for A_mn
p_in = zeros(Nr*Nt,1);   %this should be known at the beginning; provided by simulation

%over-determined equations Ax=b
x = A\p_in;

%in x stores A_mn with n=0,m=1,2,3,...  at last ,it's A00
%check! fini!



